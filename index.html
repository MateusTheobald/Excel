<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Atualizador de Planilhas com Pré-Visualização</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    display: flex;
    justify-content: center;
    padding: 30px;
}

.container {
    background: #fff;
    padding: 30px 40px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    max-width: 900px;
    width: 100%;
}

h1 {
    text-align: center;
    color: #333;
    margin-bottom: 25px;
}

label {
    font-weight: bold;
    margin-top: 15px;
    display: block;
}

input[type="file"], select {
    width: 100%;
    padding: 8px 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

button {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    border: none;
    background-color: #4CAF50;
    color: white;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}

button:hover {
    background-color: #45a049;
}

.mapping {
    margin-top: 15px;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #fafafa;
}

.mapping h3 {
    margin-top: 0;
}

.mapping select {
    margin-bottom: 10px;
    width: 100%;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table, th, td {
    border: 1px solid #ccc;
}

th, td {
    padding: 8px;
    text-align: center;
}

.progress-container {
    width: 100%;
    background-color: #ddd;
    border-radius: 8px;
    margin-top: 20px;
    overflow: hidden;
}

.progress-bar {
    width: 0%;
    height: 20px;
    background-color: #4CAF50;
    text-align: center;
    color: white;
    line-height: 20px;
    border-radius: 8px;
}

h3 { margin-top: 30px; }

#contadorInconsistencias {
    margin-top: 10px;
    font-weight: bold;
    color: #b30000;
}
</style>
</head>
<body>
<div class="container">
<h1>Atualizador de Planilhas com Pré-Visualização</h1>

<label>Planilha Principal:</label>
<input type="file" id="filePrincipal" accept=".xlsx">

<label>Planilhas Auxiliares:</label>
<input type="file" id="filesAux" accept=".xlsx" multiple>
<button onclick="gerarDropdowns()">Configurar Mapeamentos</button>

<div id="configContainer"></div>

<h3>Pré-Visualização do Mapeamento:</h3>
<table id="previewTable">
    <thead>
        <tr>
            <th>Planilha Auxiliar</th>
            <th>Coluna de Nomes</th>
            <th>Coluna de Valores</th>
            <th>Coluna de Destino</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h3>Inconsistências Encontradas:</h3>
<table id="inconsistenciasTable">
    <thead>
        <tr>
            <th>Planilha Auxiliar</th>
            <th>Nome Auxiliar</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<div id="contadorInconsistencias"></div>

<button onclick="verificarInconsistencias(() => alert('Verificação concluída!'))">
    Verificar Inconsistências
</button>

<div class="progress-container" style="display:none;">
    <div class="progress-bar" id="progressBar">0%</div>
</div>

<button onclick="processarPlanilhas()">Atualizar Planilha</button>
</div>

<script>
let wbPrincipal, dadosPrincipal;
let filesAux = [];
let mappings = [];

function colunaParaIndice(letra) {
    return letra.toUpperCase().charCodeAt(0) - 65;
}

function indiceParaColuna(i) {
    return String.fromCharCode(65 + i);
}

function gerarDropdowns() {
    const inputPrincipal = document.getElementById("filePrincipal").files[0];
    filesAux = Array.from(document.getElementById("filesAux").files);

    if (!inputPrincipal || filesAux.length === 0) {
        alert("Selecione a planilha principal e pelo menos uma auxiliar!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        wbPrincipal = XLSX.read(data, {type:"array"});
        dadosPrincipal = XLSX.utils.sheet_to_json(wbPrincipal.Sheets[wbPrincipal.SheetNames[0]], {header:1});

        const container = document.getElementById("configContainer");
        container.innerHTML = '';
        mappings = [];

        filesAux.forEach((file, idx) => {
            const div = document.createElement('div');
            div.className = 'mapping';
            div.innerHTML = `<h3>${file.name}</h3>
                <label>Coluna de nomes na planilha auxiliar:</label>
                <select id="nomeAux${idx}" onchange="atualizarPreview()"></select>
                <label>Coluna de valores na planilha auxiliar:</label>
                <select id="valorAux${idx}" onchange="atualizarPreview()"></select>
                <label>Coluna de destino na planilha principal:</label>
                <select id="destinoPrincipal${idx}" onchange="atualizarPreview()"></select>
            `;
            container.appendChild(div);

            const readerAux = new FileReader();
            readerAux.onload = function(ev) {
                const dataAux = new Uint8Array(ev.target.result);
                const wbAux = XLSX.read(dataAux, {type:"array"});
                const dadosAux = XLSX.utils.sheet_to_json(wbAux.Sheets[wbAux.SheetNames[0]], {header:1});
                const colsAux = dadosAux[0].map((v,i)=>indiceParaColuna(i));

                ['nomeAux','valorAux'].forEach(idPrefix => {
                    const select = document.getElementById(`${idPrefix}${idx}`);
                    const optInicial = document.createElement('option');
                    optInicial.value = '-';
                    optInicial.text = '-';
                    select.add(optInicial);
                });

                colsAux.forEach((c,j)=>{
                    const header = dadosAux[0][j] || '';
                    const display = `${c} - ${header}`;
                    const nomeSelect = document.getElementById(`nomeAux${idx}`);
                    const valorSelect = document.getElementById(`valorAux${idx}`);
                    const opt1 = document.createElement('option'); opt1.value=c; opt1.text=display; nomeSelect.add(opt1);
                    const opt2 = document.createElement('option'); opt2.value=c; opt2.text=display; valorSelect.add(opt2);
                });

                const destinoSelect = document.getElementById(`destinoPrincipal${idx}`);
                const optDestinoInicial = document.createElement('option');
                optDestinoInicial.value = '-';
                optDestinoInicial.text = '-';
                destinoSelect.add(optDestinoInicial);

                dadosPrincipal[0].forEach((v,i)=>{
                    const letra = indiceParaColuna(i);
                    const texto = `${letra} - ${v || ''}`;
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = texto;
                    destinoSelect.add(opt);
                });

                atualizarPreview();
            };
            readerAux.readAsArrayBuffer(file);
            mappings.push({fileIndex: idx});
        });
    };
    reader.readAsArrayBuffer(inputPrincipal);
}

function atualizarPreview() {
    const tbody = document.querySelector("#previewTable tbody");
    tbody.innerHTML = '';

    mappings.forEach((map, idx) => {
        const nome = document.getElementById(`nomeAux${idx}`).value || '-';
        const valor = document.getElementById(`valorAux${idx}`).value || '-';
        const destino = document.getElementById(`destinoPrincipal${idx}`).selectedOptions[0]?.text || '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${filesAux[idx].name}</td><td>${nome}</td><td>${valor}</td><td>${destino}</td>`;
        tbody.appendChild(tr);
    });
}

function verificarInconsistencias(callback) {
    const tbody = document.querySelector("#inconsistenciasTable tbody");
    tbody.innerHTML = '';
    document.getElementById("contadorInconsistencias").innerText = '';

    let readersCompleted = 0;
    let totalInconsistencias = 0;

    mappings.forEach((map, idx) => {
        const nomeAux = document.getElementById(`nomeAux${idx}`).value;
        const valorAux = document.getElementById(`valorAux${idx}`).value;
        const destinoPrincipal = document.getElementById(`destinoPrincipal${idx}`).value;

        if (nomeAux === '-' || valorAux === '-' || destinoPrincipal === '-') {
            readersCompleted++;
            if (readersCompleted === mappings.length) {
                document.getElementById("contadorInconsistencias").innerText = `Total: ${totalInconsistencias}`;
                callback();
            }
            return;
        }

        const readerAux = new FileReader();
        readerAux.onload = function(ev) {
            const dataAux = new Uint8Array(ev.target.result);
            const wbAux = XLSX.read(dataAux, {type:"array"});
            const dadosAux = XLSX.utils.sheet_to_json(wbAux.Sheets[wbAux.SheetNames[0]], {header:1});

            // Conjunto com nomes da planilha principal
            const nomesPrincipalSet = new Set();
            for (let r = 1; r < dadosPrincipal.length; r++) {
                const nomePrincipal = dadosPrincipal[r][0];
                if (nomePrincipal) nomesPrincipalSet.add(nomePrincipal);
            }

            // Verificar se cada nome do auxiliar existe na principal
            for (let r = 1; r < dadosAux.length; r++) {
                const nomeAuxVal = dadosAux[r][colunaParaIndice(nomeAux)];
                if (nomeAuxVal && !nomesPrincipalSet.has(nomeAuxVal)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${filesAux[idx].name}</td><td>${nomeAuxVal}</td><td>Não encontrado no principal</td>`;
                    tbody.appendChild(tr);
                    totalInconsistencias++;
                }
            }

            readersCompleted++;
            if (readersCompleted === mappings.length) {
                document.getElementById("contadorInconsistencias").innerText = `Total: ${totalInconsistencias}`;
                callback();
            }
        };
        readerAux.readAsArrayBuffer(filesAux[idx]);
    });

    if (mappings.length === 0) {
        document.getElementById("contadorInconsistencias").innerText = `Total: 0`;
        callback();
    }
}

function processarPlanilhas() {
    const colNomePrincipal = 0;
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.querySelector(".progress-container");
    progressContainer.style.display = "block";
    progressBar.style.width = '0%';
    progressBar.innerText = '0%';

    verificarInconsistencias(() => {
        const tbodyInc = document.querySelector("#inconsistenciasTable tbody");
        if (tbodyInc.children.length > 0) {
            if (!confirm("Existem nomes inconsistentes. Deseja continuar e salvar mesmo assim?")) {
                return;
            }
        }

        let processNext = (i) => {
            if (i >= filesAux.length) {
                const wsNova = XLSX.utils.aoa_to_sheet(dadosPrincipal);
                const wbNova = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wbNova, wsNova, "Atualizada");
                XLSX.writeFile(wbNova, "Planilha_Atualizada.xlsx");
                alert("Planilha atualizada com sucesso!");
                progressBar.style.width = '100%';
                progressBar.innerText = '100%';
                return;
            }

            const file = filesAux[i];
            const readerAux = new FileReader();
            readerAux.onload = function(ev) {
                const dataAux = new Uint8Array(ev.target.result);
                const wbAux = XLSX.read(dataAux, {type:"array"});
                const dadosAux = XLSX.utils.sheet_to_json(wbAux.Sheets[wbAux.SheetNames[0]], {header:1});

                const nomeAux = document.getElementById(`nomeAux${i}`).value;
                const valorAux = document.getElementById(`valorAux${i}`).value;
                const destinoPrincipal = document.getElementById(`destinoPrincipal${i}`).value;

                if (nomeAux !== '-' && valorAux !== '-' && destinoPrincipal !== '-') {
                    const mapa = {};
                    for (let r = 1; r < dadosAux.length; r++) {
                        const nome = dadosAux[r][colunaParaIndice(nomeAux)];
                        const valor = dadosAux[r][colunaParaIndice(valorAux)];
                        if (nome !== undefined) mapa[nome] = valor;
                    }
                    for (let r = 1; r < dadosPrincipal.length; r++) {
                        const nome = dadosPrincipal[r][colNomePrincipal];
                        dadosPrincipal[r][parseInt(destinoPrincipal)] = mapa[nome] !== undefined ? mapa[nome] : "";
                    }
                }

                const pct = Math.round(((i+1)/filesAux.length)*100);
                progressBar.style.width = pct+'%';
                progressBar.innerText = pct+'%';

                processNext(i+1);
            };
            readerAux.readAsArrayBuffer(file);
        };

        processNext(0);
    });
}
</script>
</body>
</html>
